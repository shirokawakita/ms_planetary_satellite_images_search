# 🛰️ Sentinel衛星データ取得アプリ

Microsoft Planetary ComputerからSentinel-1およびSentinel-2の衛星画像を取得・表示するStreamlitアプリです。

## ✨ 主な機能

- 🌍 **任意の場所・日時での衛星データ検索**
- 🛰️ **Sentinel-1（SAR）・Sentinel-2（光学）データに対応**
- 🗺️ **インタラクティブ地図操作**
  - シングルクリックで選択点を設定
  - ダブルクリックで地図中心を移動
  - 主要都市への瞬時移動ボタン（9都市対応）
  - 範囲サイズのリアルタイム調整
- 🎯 **改良されたデータ選択機能**
  - 検索結果から任意のデータを選択可能
  - 雲量順・日付順の自動ソート
  - リアルタイムプレビュー更新
- ☁️ **雲量フィルタリング機能**（Sentinel-2）
- 🖼️ **詳細な画像プレビューと情報表示**
- 📊 **検索結果の詳細統計**（件数、平均雲量など）
- 🎨 **RGB画像生成**（Sentinel-2）
- 📍 **視覚的な範囲設定とプレビュー機能**

## 🚀 セットアップ

### 1. 依存関係のインストール

```bash
pip install -r requirements.txt
```

### 2. アプリの起動

```bash
streamlit run app.py
```

## 📖 使い方

### 基本的な操作手順

1. **📡 衛星データタイプの選択**
   - **Sentinel-2 (光学)**: 可視光・近赤外の光学画像（雲量フィルタ対応）
   - **Sentinel-1 (SAR)**: 合成開口レーダー画像（天候に左右されない）

2. **📅 日時範囲の設定**
   - 開始日と終了日をカレンダーで選択
   - 最近30日間がデフォルト設定

3. **🗺️ 場所の指定**
   
   **地図を使った選択（推奨）:**
   - 🖱️ **シングルクリック**: 選択点（赤いマーカー）を移動
   - 🖱️ **ダブルクリック**: 地図中心を移動
   - 🏙️ **都市ボタン**: 主要都市に瞬時移動
     - 東京、大阪、名古屋、京都、福岡、札幌、仙台、広島、富士山
   - 📐 **範囲サイズスライダー**: 検索範囲をリアルタイム調整
   - 🎯 **座標微調整**: 数値入力で精密調整
   
   **座標直接入力:**
   - 緯度・経度の最小値・最大値を数値で入力

4. **⚙️ フィルタ設定**（Sentinel-2のみ）
   - 最大雲量の設定（0-100%）
   - デフォルト: 30%以下

5. **🔍 データ検索**
   - サイドバーの「🔍 データを検索」ボタンをクリック
   - 検索結果数と平均雲量を確認

6. **🎯 データ選択**
   - 検索結果から任意のデータを選択
   - **Sentinel-2**: 雲量が少ない順に表示
   - **Sentinel-1**: 撮影日が新しい順に表示
   - セレクトボックスで選択変更時に即座に更新

7. **🖼️ 結果確認**
   - プレビュー画像の表示
   - 詳細情報（撮影日、雲量、データID等）
   - 利用可能なバンド・アセット情報
   - RGB画像生成（Sentinel-2）

### 🗺️ 地図操作機能

| 操作 | 機能 | 説明 |
|------|------|------|
| **シングルクリック** | 選択点設定 | 赤いマーカーが移動し、検索中心を設定 |
| **ダブルクリック** | 地図中心移動 | 地図がクリック位置を中心に移動 |
| **都市ボタン** | 瞬時移動 | 主要9都市に一発移動 |
| **範囲スライダー** | サイズ調整 | 0.01-1.0度（約1-100km）で調整 |
| **中心移動ボタン** | 確実な移動 | 選択点と地図中心の相互移動 |

### 📍 主要都市座標（ワンクリック移動対応）

| 都市 | 緯度 | 経度 | 特徴 |
|------|------|------|------|
| 🗼 **東京** | 35.681° | 139.767° | 首都圏・都市部観測 |
| 🏰 **大阪** | 34.694° | 135.502° | 関西圏・都市部観測 |
| 🏭 **名古屋** | 35.181° | 136.906° | 中部圏・工業地帯 |
| ⛩️ **京都** | 35.012° | 135.768° | 歴史都市・盆地地形 |
| 🌸 **福岡** | 33.590° | 130.402° | 九州圏・沿岸都市 |
| ❄️ **札幌** | 43.064° | 141.347° | 北海道・雪氷観測 |
| 🌾 **仙台** | 38.268° | 140.869° | 東北圏・農業地帯 |
| 🦌 **広島** | 34.385° | 132.455° | 中国圏・瀬戸内海 |
| 🗻 **富士山** | 35.361° | 138.727° | 火山・自然観測 |

## 🔧 技術仕様

### 使用ライブラリ

- **Streamlit**: Webアプリフレームワーク
- **streamlit-folium**: インタラクティブ地図コンポーネント
- **pystac-client**: STAC APIクライアント
- **planetary-computer**: Microsoft Planetary Computer API
- **rasterio**: ラスターデータ処理
- **geopandas**: 地理空間データ処理
- **folium**: インタラクティブ地図生成
- **numpy/matplotlib**: 数値計算・可視化

### データソース

- **Microsoft Planetary Computer STAC API**
- **Sentinel-1 GRD**（地上範囲検出）データ
- **Sentinel-2 L2A**（大気補正済み）データ

### 座標系

- **入力**: WGS84（EPSG:4326）
- **画像データ**: UTM（データごとに自動選択）

## 💡 使い方のコツ

### 🎯 効率的な検索

- **範囲サイズ0.05度（約5km）**が観測に最適
- **雲量20%以下**に設定すると良質な光学画像を取得
- **都市ボタン**で大まかに移動してから**微調整**が効率的
- **ダブルクリック**で興味のある場所へ素早く移動

### 📊 データ選択のポイント

- **Sentinel-2**: 雲量が少ないデータを優先
- **Sentinel-1**: より新しいデータを優先
- **プレビュー画像**で雲の状態を目視確認
- **詳細プロパティ**で追加情報を確認

### 🚀 パフォーマンス向上

- 検索範囲は**0.1度以下**を推奨
- 日時範囲は**1ヶ月以内**から開始
- 複数データの比較時は**同一条件**で検索

## 🔍 トラブルシューティング

### よくある問題

1. **❌ データが見つからない**
   ```
   ✅ 解決方法:
   - 日時範囲を広げる（例：3ヶ月→6ヶ月）
   - 雲量フィルタを緩める（例：30%→70%）
   - 座標範囲が海上でないか確認
   - 主要都市ボタンでテスト検索
   ```

2. **🐌 アプリが重い**
   ```
   ✅ 解決方法:
   - 検索範囲を0.05度以下に縮小
   - 日時範囲を1ヶ月以内に短縮
   - ブラウザのキャッシュをクリア
   - ページを再読み込み
   ```

3. **🖼️ 画像が表示されない**
   ```
   ✅ 解決方法:
   - インターネット接続を確認
   - データ選択から別の画像を選択
   - しばらく待ってから再試行
   ```

4. **🗺️ 地図クリックが反応しない**
   ```
   ✅ 解決方法:
   - 地図の空白部分をクリック
   - 座標数値入力で代替設定
   - ページを再読み込み
   ```

### エラーメッセージ

| エラーメッセージ | 原因 | 解決方法 |
|------------------|------|----------|
| `データが見つかりませんでした` | 検索条件が厳しすぎる | 条件を緩和（日時範囲拡大、雲量上限増加） |
| `座標の範囲が不正です` | 緯度経度の値が範囲外 | -90~90度（緯度）、-180~180度（経度）を確認 |
| `画像生成中にエラー` | ネットワークまたはサーバーエラー | インターネット接続確認、時間を空けて再試行 |
| `データ選択処理でエラー` | データ形式の問題 | 別のデータを選択、ページを再読み込み |

## ⚠️ 制限事項

- **検索範囲**: 1度×1度以内を推奨（パフォーマンス上）
- **日時範囲**: 過去2年以内のデータが豊富
- **雲量フィルタ**: Sentinel-2のみ対応
- **大容量データ**: ダウンロードには時間がかかる場合あり
- **同時アクセス**: 複数ブラウザでの同時使用は非推奨

## 🎯 今後の予定

- [x] ✅ **インタラクティブ地図での範囲選択**（完了）
- [x] ✅ **地図クリックイベントでの座標取得**（完了）
- [x] ✅ **主要都市への瞬時移動機能**（完了）
- [x] ✅ **データ選択機能の改良**（完了）
- [ ] 🔄 **住所から座標への変換機能**
- [ ] 🔄 **ポリゴン描画機能**
- [ ] 🔄 **より高度な画像処理機能**
- [ ] 🔄 **データのエクスポート機能**
- [ ] 🔄 **バッチ処理機能**
- [ ] 🔄 **時系列データ分析機能**

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🔗 参考資料

- [Microsoft Planetary Computer](https://planetarycomputer.microsoft.com/)
- [STAC Specification](https://stacspec.org/)
- [Sentinel-1 ドキュメント](https://sentinels.copernicus.eu/web/sentinel/missions/sentinel-1)
- [Sentinel-2 ドキュメント](https://sentinels.copernicus.eu/web/sentinel/missions/sentinel-2)
- [Streamlit Documentation](https://docs.streamlit.io/)
- [Folium Documentation](https://python-visualization.github.io/folium/)

## 🙋‍♂️ サポート

問題や質問がございましたら、以下の手順で解決を試してください：

1. **📖 このREADMEのトラブルシューティングセクションを確認**
2. **🔄 ページの再読み込みを試行**
3. **🗺️ 主要都市ボタンでテスト検索を実行**
4. **⚙️ 検索条件を緩めて再試行**

---

**🚀 Happy Satellite Data Exploration! 🛰️** 